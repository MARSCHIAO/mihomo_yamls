name: Download YAML Files

on:
  schedule:
    - cron: '30 22 * * *' # UTC 22:30 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥6:30
  workflow_dispatch:
    inputs:
      category:
        description: 'é€‰æ‹©è¦æ›´æ–°çš„ç±»åˆ«'
        required: false
        type: choice
        options:
          - all
          - official
          - general
          - smart
          - mobile
        default: all

permissions:
  contents: write

jobs:
  # ç¬¬ä¸€é˜¶æ®µ: ä¸‹è½½æ‰€æœ‰é…ç½®
  download-configs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category:
          - official
          - general
          - smart
          - mobile
      fail-fast: false # å³ä½¿æŸä¸ªä»»åŠ¡å¤±è´¥ï¼Œå…¶ä»–ä»»åŠ¡ç»§ç»­æ‰§è¡Œ
      max-parallel: 4 # æœ€å¤šå¹¶è¡Œ4ä¸ªä»»åŠ¡
    
    # æ ¹æ®æ‰‹åŠ¨è¾“å…¥è¿‡æ»¤ä»»åŠ¡
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.category == 'all' ||
      github.event.inputs.category == matrix.category
    
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: ä¸‹è½½é…ç½®æ–‡ä»¶
        id: download
        run: |
          case "${{ matrix.category }}" in
            official)
              echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹ç¤ºä¾‹é…ç½®..."
              mkdir -p "Official_Examples/Metacubex"
              curl -s -o "Official_Examples/Metacubex/rule-set_config.yaml" \
                "https://wiki.metacubex.one/example/mrs"
              curl -s -o "Official_Examples/Metacubex/geox_config.yaml" \
                "https://wiki.metacubex.one/example/geox"
              artifact_path="Official_Examples"
              ;;
            
            general)
              echo "ğŸ“¥ ä¸‹è½½é€šç”¨é…ç½®..."
              bash .github/scripts/download-general.sh
              artifact_path="General_Config"
              ;;
            
            smart)
              echo "ğŸ“¥ ä¸‹è½½Smartæ¨¡å¼é…ç½®..."
              bash .github/scripts/download-smart.sh
              artifact_path="Smart_Mode"
              ;;
            
            mobile)
              echo "ğŸ“¥ ä¸‹è½½ç§»åŠ¨æ¨¡å—é…ç½®..."
              bash .github/scripts/download-mobile.sh
              artifact_path="Mobile_Modules"
              ;;
          esac
          
          echo "artifact_path=$artifact_path" >> $GITHUB_OUTPUT

      - name: éªŒè¯ä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” éªŒè¯ ${{ matrix.category }} é…ç½®..."
          
          total=0
          success=0
          failed=0
          
          case "${{ matrix.category }}" in
            official) dir="Official_Examples" ;;
            general) dir="General_Config" ;;
            smart) dir="Smart_Mode" ;;
            mobile) dir="Mobile_Modules" ;;
          esac
          
          if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
              total=$((total + 1))
              size=$(wc -c < "$file")
              
              if [ $size -gt 100 ]; then  # æ–‡ä»¶å¤§äº100å­—èŠ‚æ‰ç®—æˆåŠŸ
                success=$((success + 1))
                echo "âœ… ${file}: ${size} bytes"
              else
                failed=$((failed + 1))
                echo "âŒ ${file}: ${size} bytes (too small)"
              fi
            done < <(find "$dir" -type f -name "*.yaml" -print0)
          fi
          
          echo ""
          echo "ğŸ“Š ç»Ÿè®¡ç»“æœ:"
          echo "  æ€»è®¡: $total ä¸ªæ–‡ä»¶"
          echo "  æˆåŠŸ: $success ä¸ªæ–‡ä»¶"
          echo "  å¤±è´¥: $failed ä¸ªæ–‡ä»¶"
          
          # å¦‚æœå¤±è´¥ç‡è¶…è¿‡50%ï¼Œæ ‡è®°ä¸ºè­¦å‘Š
          if [ $total -gt 0 ] && [ $((failed * 2)) -gt $total ]; then
            echo "âš ï¸  è­¦å‘Š: å¤±è´¥ç‡è¿‡é«˜!"
          fi

      - name: ä¸Šä¼  artifact
        uses: actions/upload-artifact@v4
        with:
          name: configs-${{ matrix.category }}
          path: ${{ steps.download.outputs.artifact_path }}
          retention-days: 1

  # ç¬¬äºŒé˜¶æ®µ: åˆå¹¶æ‰€æœ‰é…ç½®å¹¶æäº¤
  commit-changes:
    needs: download-configs
    runs-on: ubuntu-latest
    if: always() # å³ä½¿æŸäº›ä¸‹è½½ä»»åŠ¡å¤±è´¥ä¹Ÿæ‰§è¡Œ
    
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0 # è·å–å®Œæ•´å†å²

      - name: ä¸‹è½½æ‰€æœ‰ artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-configs

      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ“¦ åˆå¹¶é…ç½®æ–‡ä»¶..."
          
          # ç§»åŠ¨æ‰€æœ‰ä¸‹è½½çš„é…ç½®åˆ°å¯¹åº”ç›®å½•
          if [ -d "downloaded-configs" ]; then
            for artifact in downloaded-configs/configs-*; do
              if [ -d "$artifact" ]; then
                echo "  å¤„ç† $(basename $artifact)..."
                cp -r "$artifact"/* . 2>/dev/null || true
              fi
            done
          fi
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf downloaded-configs

      - name: ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
        id: report
        run: |
          echo "ğŸ“ ç”Ÿæˆæ›´æ–°æŠ¥å‘Š..."
          
          report="## é…ç½®æ›´æ–°æŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')

"
          
          # ç»Ÿè®¡å„ç±»åˆ«æ–‡ä»¶æ•°
          for dir in Official_Examples General_Config Smart_Mode Mobile_Modules; do
            if [ -d "$dir" ]; then
              count=$(find "$dir" -type f -name "*.yaml" | wc -l)
              size=$(du -sh "$dir" 2>/dev/null | cut -f1)
              report="${report}
### ${dir}
- æ–‡ä»¶æ•°é‡: ${count}
- æ€»å¤§å°: ${size}
"
            fi
          done
          
          echo "$report"
          echo "$report" > UPDATE_REPORT.md

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          commit_msg="ğŸ”„ è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶ [$(date +'%Y-%m-%d %H:%M:%S')]

$(cat UPDATE_REPORT.md)"
          
          git commit -m "$commit_msg"
          git push origin HEAD:${{ github.ref_name }}
          
          echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€"

      - name: æ¸…ç†æ—§çš„ artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v2
        with:
          name: configs-*
