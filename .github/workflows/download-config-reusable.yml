name: Download Config (Reusable)

on:
  workflow_call:
    inputs:
      category:
        description: 'é…ç½®ç±»åˆ« (å¦‚: General_Config, Smart_Mode)'
        required: true
        type: string
      source_name:
        description: 'é…ç½®æºåç§° (å¦‚: Yiteei, 666OS)'
        required: true
        type: string
      files:
        description: 'JSONæ ¼å¼çš„æ–‡ä»¶åˆ—è¡¨: [{"name":"file.yaml","url":"https://..."}]'
        required: true
        type: string

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: ä¸‹è½½ ${{ inputs.source_name }} é…ç½®
        run: |
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ ${{ inputs.source_name }} é…ç½®..."
          mkdir -p "${{ inputs.category }}/${{ inputs.source_name }}"
          
          # è§£æ JSON å¹¶ä¸‹è½½æ–‡ä»¶
          echo '${{ inputs.files }}' | jq -c '.[]' | while read -r item; do
            filename=$(echo "$item" | jq -r '.name')
            url=$(echo "$item" | jq -r '.url')
            
            echo "  â¬‡ï¸  ä¸‹è½½ $filename..."
            if curl -s -f -o "${{ inputs.category }}/${{ inputs.source_name }}/$filename" "$url"; then
              size=$(wc -c < "${{ inputs.category }}/${{ inputs.source_name }}/$filename")
              echo "  âœ… $filename: ${size} bytes"
            else
              echo "  âŒ $filename ä¸‹è½½å¤±è´¥"
            fi
          done

      - name: éªŒè¯ä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
          total=0
          success=0
          
          for file in ${{ inputs.category }}/${{ inputs.source_name }}/*.yaml; do
            if [ -f "$file" ]; then
              total=$((total + 1))
              size=$(wc -c < "$file")
              if [ $size -gt 0 ]; then
                success=$((success + 1))
                echo "âœ… $(basename $file): ${size} bytes"
              else
                echo "âš ï¸  $(basename $file): æ–‡ä»¶ä¸ºç©º"
              fi
            fi
          done
          
          echo ""
          echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡: $success/$total ä¸ªæ–‡ä»¶æˆåŠŸ"

      - name: ä¸Šä¼  artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.category }}-${{ inputs.source_name }}
          path: ${{ inputs.category }}/${{ inputs.source_name }}/
          retention-days: 1
