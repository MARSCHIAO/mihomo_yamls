name: Generate Sub-READMEs

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Update File Test"]
    types:
      - completed

permissions:
  contents: write

jobs:
  generate-readmes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: æ£€æŸ¥ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install pyyaml

      - name: è¿è¡Œæ™ºèƒ½å¯¹æ¯”ç”Ÿæˆè„šæœ¬
        run: |
          python3 -c '
          import os
          import urllib.parse
          import yaml
          import re
          
          # --- 0. æ ¸å¿ƒä¿®å¤ï¼šè®© PyYAML å¿½ç•¥è‡ªå®šä¹‰æ ‡ç­¾ ---
          # å¾ˆå¤š Clash é…ç½®åŒ…å« !include ç­‰æ ‡ç­¾ï¼Œä¼šå¯¼è‡´æŠ¥é”™ï¼Œè¿™é‡Œå¼ºåˆ¶å¿½ç•¥å®ƒä»¬
          yaml.add_multi_constructor("!", lambda loader, suffix, node: None, Loader=yaml.SafeLoader)

          # --- é…ç½®åŒºåŸŸ ---
          REPO_URL = "https://github.com/${{ github.repository }}/blob/main"
          
          DIR_MAP = {
              "Official_Examples": "Mihomo å®˜æ–¹ç¤ºä¾‹ (Official)",
              "General_Config": "é€šç”¨è¿›é˜¶é…ç½® (General Config)",
              "Smart_Mode": "Smart æ¨¡å¼ / è·¯ç”±ä¸“ç”¨ (Smart Mode)",
              "Mobile_Modules": "Android æ‰‹æœºæ¨¡å— (Mobile Modules)"
          }

          IGNORE_DIRS = [".git", ".github"]
          IGNORE_FILES = ["README.md", "LICENSE", "release_body.md"]

          # --- è¾…åŠ©å‡½æ•° ---

          def safe_get(data, keys, default="N/A"):
              val = data
              try:
                  for key in keys:
                      val = val[key]
                  return val
              except:
                  return default

          def get_file_size(path):
              try:
                  size = os.path.getsize(path)
                  if size < 1024: return f"{size} B"
                  return f"{size/1024:.1f} KB"
              except: return "Unknown"

          def read_file_content(file_path):
              """å°è¯•ä½¿ç”¨å¤šç§ç¼–ç è¯»å–æ–‡ä»¶ï¼Œå¹¶å¤„ç† Tab ç¼©è¿›é—®é¢˜"""
              content = ""
              try:
                  with open(file_path, "r", encoding="utf-8") as f:
                      content = f.read()
              except UnicodeDecodeError:
                  try:
                      # å°è¯• GBK/GB18030 (å¸¸è§äºä¸­æ–‡ Windows ç¯å¢ƒ)
                      with open(file_path, "r", encoding="gb18030", errors="ignore") as f:
                          content = f.read()
                  except Exception:
                      return None
              
              # ä¿®å¤ YAML ä¸å…è®¸ Tab ç¼©è¿›çš„é—®é¢˜
              if "\t" in content:
                  content = content.replace("\t", "  ")
              
              return content

          def analyze_single_config(file_path):
              """è§£æå•ä¸ª YAML å¹¶è¿”å›ç»“æ„åŒ–æ•°æ®"""
              try:
                  raw_content = read_file_content(file_path)
                  if not raw_content:
                      print(f"Warning: Could not read content of {file_path}")
                      return None

                  # ä½¿ç”¨ SafeLoader åŠ è½½ï¼Œå‰é¢å·²ç»é…ç½®äº†å¿½ç•¥ ! æ ‡ç­¾
                  data = yaml.safe_load(raw_content)
                  
                  if not isinstance(data, dict):
                      print(f"Warning: {file_path} is not a valid YAML dictionary")
                      return None

                  info = {}
                  
                  # --- 1. åŸºç¡€ä¿¡æ¯ ---
                  info["mode"] = safe_get(data, ["mode"], "Rule")
                  info["ipv6"] = "âœ…" if str(safe_get(data, ["ipv6"])).lower() == "true" else "ğŸš«"
                  info["allow_lan"] = "âœ…" if str(safe_get(data, ["allow-lan"])).lower() == "true" else "ğŸš«"
                  info["tun"] = "âœ… å¼€å¯" if safe_get(data, ["tun", "enable"], False) else "ğŸš« å…³é—­"

                  # --- 2. ç«¯å£ä¿¡æ¯æå– ---
                  info["port_mixed"] = safe_get(data, ["mixed-port"], "-")
                  info["port_http"] = safe_get(data, ["port"], "-")
                  info["port_socks"] = safe_get(data, ["socks-port"], "-")
                  info["port_redir"] = safe_get(data, ["redir-port"], "-")
                  info["port_tproxy"] = safe_get(data, ["tproxy-port"], "-")
                  info["port_ctrl"] = safe_get(data, ["external-controller"], "-")
                  
                  info["listeners_raw"] = []
                  listeners = data.get("listeners", [])
                  if listeners and isinstance(listeners, list):
                      for l in listeners:
                          if isinstance(l, dict):
                              name = l.get("name", "Unknown")
                              port = l.get("port", "?")
                              l_type = l.get("type", "mixed")
                              info["listeners_raw"].append(f"| ğŸ‘‚ {name} | {port} | {l_type} |")

                  info["ports_display"] = []
                  if info["port_mixed"] != "-": info["ports_display"].append(f"| Mixed (æ··åˆ) | {info['port_mixed']} | HTTP/SOCKS |")
                  if info["port_http"] != "-": info["ports_display"].append(f"| HTTP | {info['port_http']} | ä»… HTTP |")
                  if info["port_socks"] != "-": info["ports_display"].append(f"| SOCKS5 | {info['port_socks']} | ä»… SOCKS |")
                  if info["port_redir"] != "-": info["ports_display"].append(f"| Redirect | {info['port_redir']} | é€æ˜ä»£ç† (TCP) |")
                  if info["port_tproxy"] != "-": info["ports_display"].append(f"| TProxy | {info['port_tproxy']} | é€æ˜ä»£ç† (UDP) |")
                  if info["port_ctrl"] != "-": info["ports_display"].append(f"| Controller | {info['port_ctrl']} | æ§åˆ¶é¢æ¿ |")

                  # --- 3. ç»Ÿè®¡ä¿¡æ¯ ---
                  groups = data.get("proxy-groups", [])
                  info["group_count"] = len(groups) if isinstance(groups, list) else 0
                  
                  rules = data.get("rules", [])
                  info["rule_count"] = len(rules) if isinstance(rules, list) else 0
                  
                  # --- 4. è¯¦æƒ…æå– ---
                  info["groups_raw"] = []
                  if isinstance(groups, list):
                      for pg in groups:
                          if isinstance(pg, dict):
                              name = pg.get("name", "Unknown")
                              type_ = pg.get("type", "select")
                              icon = "ğŸš€"
                              if "auto" in type_ or "url-test" in type_: icon = "â™»ï¸"
                              elif "fallback" in type_: icon = "ğŸ”§"
                              elif "load-balance" in type_: icon = "âš–ï¸"
                              elif "select" in type_: icon = "ğŸ‘†"
                              info["groups_raw"].append(f"| {icon} {name} | `{type_}` |")

                  info["dns_raw"] = []
                  dns = data.get("dns", {})
                  if isinstance(dns, dict) and dns.get("enable", False):
                      nameservers = dns.get("nameserver", [])
                      if isinstance(nameservers, list):
                          for ns in nameservers:
                              if isinstance(ns, str):
                                  provider = "DoT" if "tls://" in ns else "DoH" if "https://" in ns else "UDP"
                                  info["dns_raw"].append(f"| {provider} | `{ns}` |")
                  
                  return info
              except Exception as e:
                  print(f"âŒ Error parsing {file_path}: {e}")
                  return None

          def generate_comparison_table(configs_data):
              """ç”Ÿæˆæ¨ªå‘å¯¹æ¯”è¡¨æ ¼"""
              headers = ["ç‰¹æ€§ / æ–‡ä»¶", "å¤§å°"] 
              for filename in configs_data.keys():
                  headers.append(f"`{filename}`")
              
              lines = []
              lines.append("| " + " | ".join(headers) + " |")
              lines.append("| :--- | :--- " + "| :--- " * len(configs_data) + "|")
              
              rows = [
                  ("port_mixed", "æ··åˆç«¯å£ (Mixed)"),
                  ("port_ctrl", "æ§åˆ¶é¢æ¿ (Ctrl)"),
                  ("mode", "è¿è¡Œæ¨¡å¼"),
                  ("tun", "TUN æ¨¡å¼"),
                  ("group_count", "ç­–ç•¥ç»„æ•°"),
                  ("rule_count", "è§„åˆ™æ¡æ•°"),
              ]

              size_row = ["**æ–‡ä»¶å¤§å°**", "-"]
              for filename, data in configs_data.items():
                  size_row.append(data["file_size"])
              lines.append("| " + " | ".join(size_row) + " |")

              for key, label in rows:
                  row_content = [f"**{label}**", "-"]
                  for filename, data in configs_data.items():
                      val = data.get("parsed", {}).get(key, "N/A")
                      if key in ["group_count", "rule_count"]:
                          val = f"**{val}**"
                      row_content.append(str(val))
                  lines.append("| " + " | ".join(row_content) + " |")
              
              return "\n".join(lines)

          def generate_readme(root_path, files):
              rel_path = os.path.relpath(root_path, ".")
              folder_name = os.path.basename(root_path)
              title = DIR_MAP.get(folder_name, folder_name)

              configs_data = {} 
              valid_yaml_files = []
              
              for f in sorted(files):
                  if f.lower().endswith((".yaml", ".yml")) and f not in IGNORE_FILES:
                      full_path = os.path.join(root_path, f)
                      print(f"Analyzing: {f}...") # æ‰“å°æ—¥å¿—ä»¥ä¾¿è°ƒè¯•
                      parsed_info = analyze_single_config(full_path)
                      
                      # åªè¦è§£ææˆåŠŸï¼Œå“ªæ€•è§„åˆ™æ•°ä¸º0ä¹ŸåŠ å…¥ï¼Œæ–¹ä¾¿è°ƒè¯•æ˜¾ç¤º N/A
                      if parsed_info: 
                          # åªè¦æ˜¯æœ‰æ•ˆçš„å­—å…¸è¿”å›ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºå®ƒæ˜¯åˆæ³•çš„ Config
                          configs_data[f] = {
                              "file_size": get_file_size(full_path),
                              "parsed": parsed_info
                          }
                          valid_yaml_files.append(f)
                      else:
                          print(f"Skipping {f}: Parse failed.")

              content = []
              content.append(f"# ğŸ“‚ {title}\n")
              
              depth = rel_path.count(os.sep) + 1
              back_link = "../" * depth + "README.md"
              content.append(f"[ğŸ”™ è¿”å›ä¸»é¡µ (Return to Home)]({back_link})\n")
              content.append("> ğŸ¤– **è‡ªåŠ¨åˆ†ææŠ¥å‘Š** | Auto-generated Report\n")

              if len(configs_data) > 1:
                  content.append("## âš”ï¸ é…ç½®æ¨ªå‘å¯¹æ¯” (Comparison)\n")
                  content.append(generate_comparison_table(configs_data))
                  content.append("\n")
              
              if configs_data:
                  content.append("## ğŸ“„ é…ç½®æ–‡ä»¶è¯¦è§£ (Details)\n")
                  for filename, data in configs_data.items():
                      info = data["parsed"]
                      file_url = f"{REPO_URL}/{urllib.parse.quote(rel_path)}/{urllib.parse.quote(filename)}"
                      
                      content.append(f"### ğŸ“ {filename}")
                      content.append(f"- **å¤§å°**: {data['file_size']}") 
                      content.append(f"- **é“¾æ¥**: [æŸ¥çœ‹æºç ]({file_url})")

                      if info["ports_display"] or info["listeners_raw"]:
                          content.append(f"\n#### ğŸ“¶ ç½‘ç»œç«¯å£é…ç½® (Ports)")
                          content.append("| ç±»å‹ | ç«¯å£/åœ°å€ | è¯´æ˜ |")
                          content.append("| :--- | :--- | :--- |")
                          content.extend(info["ports_display"])
                          if info["listeners_raw"]:
                              for l in info["listeners_raw"]:
                                  content.append(l)
                          content.append("\n")

                      if info["groups_raw"]:
                          content.append(f"<details>")
                          content.append(f"<summary><b>ğŸ” ç‚¹å‡»æŸ¥çœ‹ç­–ç•¥ç»„æ¶æ„ ({info['group_count']}ä¸ª)</b></summary>\n")
                          content.append("| ç­–ç•¥ç»„ (Group) | ç±»å‹ (Type) |")
                          content.append("| :--- | :--- |")
                          content.extend(info["groups_raw"][:15])
                          if len(info["groups_raw"]) > 15:
                              content.append(f"| ... | è¿˜æœ‰ {len(info['groups_raw'])-15} ä¸ª |")
                          content.append(f"\n</details>\n")
                      
                      if info["dns_raw"]:
                          content.append(f"<details>")
                          content.append(f"<summary><b>ğŸŒ ç‚¹å‡»æŸ¥çœ‹ DNS é…ç½®</b></summary>\n")
                          content.append("| ç±»å‹ | æœåŠ¡å™¨ |")
                          content.append("| :--- | :--- |")
                          content.extend(info["dns_raw"])
                          content.append(f"\n</details>\n")
                      
                      content.append("\n---\n")

              content.append("## ğŸ“¦ æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ (File List)\n")
              content.append("| æ–‡ä»¶å | å¤§å° | é“¾æ¥ |")
              content.append("| :--- | :--- | :--- |")
              for f in sorted(files):
                  if f in IGNORE_FILES or f.startswith("."): continue
                  f_path = os.path.join(root_path, f)
                  f_url = f"{REPO_URL}/{urllib.parse.quote(rel_path)}/{urllib.parse.quote(f)}"
                  content.append(f"| `{f}` | {get_file_size(f_path)} | [æŸ¥çœ‹]({f_url}) |")

              return "\n".join(content)

          print("Starting Comparison README generation...")
          for root, dirs, files in os.walk("."):
              dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
              rel_path = os.path.relpath(root, ".")
              if rel_path == ".": continue
              
              if len([f for f in files if f not in IGNORE_FILES and f.endswith((".yaml", ".yml"))]) > 0:
                  readme_txt = generate_readme(root, files)
                  with open(os.path.join(root, "README.md"), "w", encoding="utf-8") as f:
                      f.write(readme_txt)
                  print(f"Generated for: {rel_path}")
          '

      - name: æäº¤æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add */**/README.md
          git commit -m "Docs: Fix YAML parsing issues" || echo "No changes to commit"
          
          git push origin HEAD:${{ github.ref_name }}
