name: Generate Smart READMEs

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Update File Test"]
    types: [completed]

permissions:
  contents: write

jobs:
  generate-smart-readmes:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --no-cache-dir pyyaml

      - name: Generate READMEs (auto + author-meta inheritance)
        run: |
          python3 << 'EOF'
          import os
          import yaml
          import urllib.parse

          REPO_URL = "https://github.com/${{ github.repository }}/blob/main"
          IGNORE_DIRS = {".git", ".github"}
          IGNORE_FILES = {"README.md", "LICENSE", "release_body.md"}

          # -------- å·¥å…·å‡½æ•° --------
          def load_yaml(path):
              try:
                  with open(path, encoding="utf-8") as f:
                      return yaml.safe_load(f) or {}
              except Exception:
                  return {}

          def file_size(path):
              try:
                  s = os.path.getsize(path)
                  return f"{s} B" if s < 1024 else f"{s/1024:.1f} KB"
              except Exception:
                  return "Unknown"

          def beautify(name):
              return name.replace("_", " ").replace("-", " ").title()

          def find_inherited_meta(path):
              """
              å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ ._meta.yamlï¼ˆä½œè€…çº§ / ç›®å½•çº§ï¼‰
              """
              cur = os.path.abspath(path)
              root = os.path.abspath(".")
              while True:
                  meta_path = os.path.join(cur, "._meta.yaml")
                  if os.path.isfile(meta_path):
                      return load_yaml(meta_path)
                  if cur == root:
                      return {}
                  cur = os.path.dirname(cur)

          # -------- ä¸»æµç¨‹ --------
          for root, dirs, files in os.walk("."):
              dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]

              if root == ".":
                  continue

              real_files = [
                  f for f in files
                  if not f.startswith(".") and f not in IGNORE_FILES
              ]
              if not real_files:
                  continue

              yaml_files = [
                  f for f in real_files
                  if f.lower().endswith((".yml", ".yaml"))
              ]

              # ğŸ”‘ ä½œè€…çº§ / ç›®å½•çº§ meta ç»§æ‰¿
              meta = find_inherited_meta(root)

              # æ¨¡å¼åˆ¤æ–­
              if meta.get("type"):
                  mode = meta["type"]
              else:
                  mode = "single-auto" if len(yaml_files) == 1 else "collection-auto"

              title = meta.get("title") or beautify(os.path.basename(root))

              rel = os.path.relpath(root, ".")
              lines = []
              lines.append(f"# {title}\n")

              # -------- ä½œè€…ä¿¡æ¯ï¼ˆç»§æ‰¿ç”Ÿæ•ˆçš„å…³é”®ä½“ç°ï¼‰--------
              if meta:
                  if meta.get("author"):
                      lines.append(f"> **ä½œè€…**ï¼š{meta['author']}")
                  if meta.get("project_url"):
                      lines.append(f"> **é¡¹ç›®åœ°å€**ï¼š{meta['project_url']}")
                  if meta.get("telegram"):
                      lines.append(f"> **Telegram**ï¼š{meta['telegram']}")
                  lines.append("")

              # -------- å•æ–‡ä»¶ç›®å½• --------
              if mode.startswith("single") and yaml_files:
                  f = yaml_files[0]
                  url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(f)}"
                  lines.append("## ğŸ“„ é…ç½®è¯´æ˜\n")
                  lines.append(f"- **æ–‡ä»¶å**ï¼š`{f}`")
                  lines.append(f"- **å¤§å°**ï¼š{file_size(os.path.join(root, f))}")
                  lines.append(f"- **æºç **ï¼š[æŸ¥çœ‹]({url})")

                  desc = meta.get("files", {}).get(f, {}).get("description")
                  if desc:
                      lines.append(f"\n{desc}")

              # -------- å¤šæ–‡ä»¶ç›®å½• --------
              else:
                  lines.append("## ğŸ“¦ é…ç½®æ–‡ä»¶åˆ—è¡¨\n")
                  lines.append("| æ–‡ä»¶å | å¤§å° | é“¾æ¥ |")
                  lines.append("| :--- | :--- | :--- |")

                  for f in sorted(yaml_files):
                      url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(f)}"
                      lines.append(
                          f"| `{f}` | {file_size(os.path.join(root, f))} | [æŸ¥çœ‹]({url}) |"
                      )

              # -------- å…¶ä»–æ–‡ä»¶ --------
              others = [f for f in real_files if f not in yaml_files]
              if others:
                  lines.append("\n## ğŸ“ å…¶ä»–æ–‡ä»¶\n")
                  lines.append("| æ–‡ä»¶ | å¤§å° | é“¾æ¥ |")
                  lines.append("| :--- | :--- | :--- |")
                  for f in others:
                      url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(f)}"
                      lines.append(
                          f"| `{f}` | {file_size(os.path.join(root, f))} | [æŸ¥çœ‹]({url}) |"
                      )

              # -------- Licenseï¼ˆç»§æ‰¿ï¼‰--------
              if meta.get("license"):
                  lines.append("\n## ğŸ“„ License\n")
                  lines.append(meta["license"])

              with open(os.path.join(root, "README.md"), "w", encoding="utf-8") as f:
                  f.write("\n".join(lines))

              print(f"Generated README with inheritance: {rel}")

          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add **/README.md
          git commit -m "Docs: generate READMEs with author meta inheritance" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}
